<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Skill Card Generator</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
    const firebaseConfig = {
        apiKey: "AIzaSyDmNyfhWVzDiOvxQXJrD8iTaE5Y1cRAi9k",
        authDomain: "skillplatform-test.firebaseapp.com",
        projectId: "skillplatform-test",
        storageBucket: "skillplatform-test.firebasestorage.app",
        messagingSenderId: "607447155294",
        appId: "1:607447155294:web:5fc6c198dffa88fa9aeacf"
    };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.firebaseDb = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
    </script>

    <style>
        :root {
            --primary: #000;
            --secondary: #fff;
            --accent: #f0f0f0;
            --font-stack: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-stack);
            background-color: #fafafa;
            color: #333;
            margin: 0;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        h1 { margin-bottom: 20px; }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            transition: all 0.3s ease;
        }

        .container.wide {
            max-width: 800px;
        }

        /* Form Styling */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input[type="text"], select, input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        .skill-input-group { display: flex; gap: 10px; }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: var(--primary);
            color: var(--secondary);
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.8; }
        button.secondary { background: #666; }
        
        .skills-list {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .skill-tag {
            background: var(--accent);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .remove-skill { cursor: pointer; color: #ff4444; font-weight: bold; }

        /* 3D Viewport */
        #viewport {
            width: 100%;
            height: min(60vh, 420px);
            background: #eee;
            border-radius: 8px;
            margin-top: 20px;
            cursor: grab;
            position: relative;
            overflow: hidden;
            display: none; /* Hidden initially */
        }
        #viewport:active { cursor: grabbing; }

        /* Helpers */
        .hidden { display: none !important; }
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        /* Loading Spinner */
        .loader-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #000;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Hidden canvas for texture generation */
        #texture-gen { display: none; }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            }

            #viewport {
                height: 55vh; /* take more vertical space on mobile */
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls button {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <h1 id="app-title">Skill Card Creator</h1>

    <div class="container" id="main-container">
        <div id="input-section">
            <div class="form-group">
                <label id="label-language">Language</label>
                <select id="language">
                    <option value="EN">English</option>
                    <option value="VI">Vietnamese</option>
                    <option value="ZH">Chinese</option>
                    <option value="FR">French</option>
                    <option value="ES">Spanish</option>
                    <option value="DE">German</option>
                </select>
            </div>
            <div class="form-group">
                <label id="label-fname">First Name</label>
                <input type="text" id="fname" placeholder="John">
            </div>
            <div class="form-group">
                <label id="label-lname">Last Name</label>
                <input type="text" id="lname" placeholder="Smith">
            </div>
            
            <div class="form-group">
                <label id="label-skills">Skills</label>
                <div class="skill-input-group">
                    <input type="text" id="skill-input" placeholder="e.g. Machine Learning">
                    <button type="button" id="btn-add-skill" onclick="addSkill()">Add</button>
                </div>
                <div class="skills-list" id="skills-display"></div>
            </div>

            <div class="form-group">
                <label id="label-issuer">Issuer Logo (Optional)</label>
                <input type="file" id="logo-upload" accept="image/*">
            </div>

            <button id="btn-generate" style="width:100%; margin-top: 10px;" onclick="generateCard()">Generate Skill Card</button>
        </div>

        <div id="output-section" class="hidden">
            <div id="viewport">
                <div id="loader" class="loader-overlay hidden">
                    <div class="spinner"></div>
                    <div>Generating card...</div>
                </div>
            </div>
            <p id="rotate-hint" style="text-align: center; color: #666; font-size: 0.9rem; margin-top:5px;">
                Drag left/right to rotate
            </p>
            
            <div class="controls">
                <button id="btn-edit" class="secondary" onclick="resetApp()">Edit</button>
                <button id="btn-print" onclick="downloadPDF()">Print PDF</button>
            </div>
        </div>
    </div>

    <div id="texture-gen">
        <canvas id="canvas-front" width="2048" height="1296"></canvas>
        <canvas id="canvas-back" width="2048" height="1296"></canvas>
        <div id="qr-target"></div>
    </div>

    <script>
        // --- State ---
        let skills = [];
        let cardData = {};
        let logoDataUrl = null; // Stores the uploaded image base64

        // --- Helpers ---
        
        // Generate a UUID v4
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // Get skills array for Firebase upload
        function getSkills() {
            return skills.map((skill, index) => ({
                name: skill,
                level: index + 1,
                verified: true
            }));
        }
        
        // Upload to Firebase
        async function uploadToFirebase(cardUID) {
            try {
                const userName = `${document.getElementById('fname').value || 'John'} ${document.getElementById('lname').value || 'Doe'}`;
                
                const profileData = {
                    userName: userName,
                    userLevel: parseInt(skills.length) || 1,
                    skills: getSkills(),
                    cardUID: cardUID,
                    timestamp: Date.now(),
                    lastUpdated: Date.now(),
                    lastSyncedAt: Date.now(),
                    verifiedAt: Date.now(),
                    verificationMethod: 'encoder',
                    encrypted: true,
                    signed: true
                };

                const appId = '1:607447155294:web:5fc6c198dffa88fa9aeacf';
                const cardRef = window.firebaseDoc(window.firebaseDb, 'artifacts', appId, 'public', 'data', 'cards', cardUID);
                await window.firebaseSetDoc(cardRef, profileData);
                
                console.log('Successfully uploaded to Firebase with UID:', cardUID);
                return true;
            } catch (error) {
                console.error('Error uploading to Firebase:', error);
                alert('Failed to upload to Firebase: ' + error.message);
                return false;
            }
        }
        // Fit text into a maximum width by shrinking the font size
        function setFittedFont(ctx, baseSize, minSize, fontWeight, fontFamily, text, maxWidth) {
            let size = baseSize;
            const weightPrefix = fontWeight && fontWeight.length > 0 ? fontWeight + " " : "";
            while (size > minSize) {
                ctx.font = `${weightPrefix}${size}px ${fontFamily}`;
                if (ctx.measureText(text).width <= maxWidth) break;
                size -= 1;
            }
            // ensure final font is set
            ctx.font = `${weightPrefix}${size}px ${fontFamily}`;
            return size;
        }

        // --- Translations ---
        const dictionary = {
            EN: {
                title: "Skill Card",
                subtitle: "Unlocks AI Support",
                desktop: "Desktop",
                mobile: "Mobile",
                deskSteps: [
                    "Open the SkillGPT App", 
                    "Tap your Skill Card or scan\nQR code",
                    "Open the SkillGPT website", 
                    "Scan the QR code that appears on \nthe website from the app",
                    "Skills will sync and update"
                ],
                mobSteps: [
                    "Open the SkillGPT app",
                    "Tap your Skill Card or scan\nQR code",
                    "Skills will sync and update"
                ],
                tagline: "AI is unlocked only for skills you've already proved – helping you learn first, automate second.",
                others: "other Skills",
                issued: "Issued by",
                scan1: "Scan or tap to",
                scan2: "connect to your",
                scan3: "AI tools",
                ui: {
                    appTitle: "Skill Card Creator",
                    languageLabel: "Language",
                    firstNameLabel: "First Name",
                    lastNameLabel: "Last Name",
                    skillsLabel: "Skills",
                    skillPlaceholder: "e.g. Machine Learning",
                    addSkillButton: "Add",
                    issuerLabel: "Issuer Logo (Optional)",
                    generateButton: "Generate Skill Card",
                    rotateHint: "Drag left/right to rotate",
                    editButton: "Edit",
                    printButton: "Print PDF",
                    firstNamePlaceholder: "John",
                    lastNamePlaceholder: "Smith"
                },
                pdf: {
                    headerTitle: "SkillGPT Skill Card Prototype",
                    headerSubtitle: "Human–Computer Interaction (HCI) Project – University Study",
                    generatedForPrefix: "Prototype card generated for:",
                    intro: "This prototype card is part of a Human–Computer Interaction (HCI) project exploring how to reduce negative patterns of AI use. The system encourages people to first build real skills in a domain and only then unlock AI tools to automate tasks in that domain.",
                    rationale: "By tying access to automation to demonstrated competence, the project aims to:\n• discourage over-reliance on generic AI tools,\n• promote deliberate learning and feedback, and\n• create a transparent link between verified skills, identity, and AI assistance.",
                    layoutHeading: "Prototype card layout",
                    implHeading: "Implementation notes (prototype)",
                    implText: "In a full deployment, the visual card would be rendered on a dynamic e-ink display attached to an NFC core. The NFC chip stores a URL pointing to the learner's verified skill profile, which the SkillGPT system uses to unlock appropriate AI assistance.",
                    nfcLabel: "NFC encoding (URI record – program your NFC card with this URL):",
                    footer: "SkillGPT Skill Card – HCI research prototype exploring skill-first, responsible AI use."
                }
            },
            VI: {
                title: "Thẻ Kỹ Năng",
                subtitle: "Mở khóa Hỗ trợ AI",
                desktop: "Máy tính",
                mobile: "Di động",
                deskSteps: [
                    "Truy cập SkillGPT.ai và đăng nhập",
                    "Trong 'Kết nối Thẻ kỹ năng' chọn:\n'QUEST_TR33_Was_BttR'",
                    "Kỹ năng đã xác minh sẽ đồng bộ"
                ],
                mobSteps: [
                    "Mở ứng dụng SkillGPT",
                    "Chạm Thẻ kỹ năng hoặc quét mã QR",
                    "Kỹ năng sẽ cập nhật ngay"
                ],
                tagline: "AI chỉ được mở khóa cho các kỹ năng bạn đã chứng minh – giúp bạn học trước, tự động hóa sau.",
                others: "kỹ năng khác",
                issued: "Cấp bởi",
                scan1: "Quét hoặc chạm",
                scan2: "để kết nối với",
                scan3: "công cụ AI của bạn",
                ui: {
                    appTitle: "Trình tạo Thẻ Kỹ Năng",
                    languageLabel: "Ngôn ngữ",
                    firstNameLabel: "Tên",
                    lastNameLabel: "Họ",
                    skillsLabel: "Kỹ năng",
                    skillPlaceholder: "vd. Machine Learning",
                    addSkillButton: "Thêm",
                    issuerLabel: "Logo đơn vị cấp (tùy chọn)",
                    generateButton: "Tạo thẻ kỹ năng",
                    rotateHint: "Kéo sang trái/phải để xoay",
                    editButton: "Chỉnh sửa",
                    printButton: "In PDF",
                    firstNamePlaceholder: "An",
                    lastNamePlaceholder: "Nguyễn"
                },
                pdf: {
                    headerTitle: "Nguyên mẫu Thẻ Kỹ Năng SkillGPT",
                    headerSubtitle: "Dự án Tương tác Người–Máy (HCI) – Nghiên cứu tại trường đại học",
                    generatedForPrefix: "Thẻ nguyên mẫu được tạo cho:",
                    intro: "Thẻ nguyên mẫu này là một phần của dự án HCI nhằm khám phá cách giảm các hành vi sử dụng AI tiêu cực. Hệ thống khuyến khích người học xây dựng kỹ năng thực tế trong một lĩnh vực trước, sau đó mới mở khóa các công cụ AI để tự động hóa trong lĩnh vực đó.",
                    rationale: "Bằng cách gắn quyền truy cập tự động hóa với năng lực đã được chứng minh, dự án hướng tới:\n• hạn chế phụ thuộc quá mức vào các công cụ AI chung,\n• thúc đẩy học tập có chủ đích và phản hồi, và\n• tạo mối liên kết minh bạch giữa kỹ năng đã xác minh, danh tính và hỗ trợ AI.",
                    layoutHeading: "Bố cục thẻ nguyên mẫu",
                    implHeading: "Ghi chú triển khai (nguyên mẫu)",
                    implText: "Trong triển khai đầy đủ, thẻ hiển thị sẽ được hiển thị trên một màn hình e-ink động gắn với lõi NFC. Chip NFC lưu trữ URL trỏ tới hồ sơ kỹ năng đã xác minh của người học, mà hệ thống SkillGPT sử dụng để mở khóa hỗ trợ AI phù hợp.",
                    nfcLabel: "Mã hóa NFC (bản ghi URI – ghi URL này vào thẻ NFC của bạn):",
                    footer: "Thẻ Kỹ Năng SkillGPT – nguyên mẫu nghiên cứu HCI về việc sử dụng AI có trách nhiệm dựa trên kỹ năng trước."
                }
            },
            ZH: {
                title: "技能卡",
                subtitle: "解锁 AI 支持",
                desktop: "电脑",
                mobile: "手机",
                deskSteps: [
                    "访问 SkillGPT.ai 并登录",
                    "在“连接技能卡”中选择：\n'QUEST_TR33_Was_BttR'",
                    "你已验证的技能将会同步"
                ],
                mobSteps: [
                    "打开 SkillGPT 应用",
                    "轻触技能卡或扫描二维码",
                    "技能将会同步并更新"
                ],
                tagline: "AI 只会为你已经证明掌握的技能解锁——先帮助你学习，其次才是自动化。",
                others: "个其他技能",
                issued: "签发机构",
                scan1: "扫描或贴靠",
                scan2: "以连接到你的",
                scan3: "AI 工具",
                ui: {
                    appTitle: "技能卡生成器",
                    languageLabel: "语言",
                    firstNameLabel: "名",
                    lastNameLabel: "姓",
                    skillsLabel: "技能",
                    skillPlaceholder: "例如：机器学习",
                    addSkillButton: "添加",
                    issuerLabel: "发卡机构标志（可选）",
                    generateButton: "生成技能卡",
                    rotateHint: "左右拖动以旋转",
                    editButton: "编辑",
                    printButton: "导出 PDF",
                    firstNamePlaceholder: "伟",
                    lastNamePlaceholder: "张"
                },
                pdf: {
                    headerTitle: "SkillGPT 技能卡原型",
                    headerSubtitle: "人机交互（HCI）项目 – 大学研究",
                    generatedForPrefix: "为以下对象生成的原型卡片：",
                    intro: "此原型卡片是一个人机交互项目的一部分，用于研究如何减少对 AI 的负面使用模式。系统鼓励人们先在某一领域建立真实技能，然后再解锁 AI 工具来自动化该领域中的任务。",
                    rationale: "通过将自动化访问与已证明的能力绑定在一起，本项目旨在：\n• 减少对通用 AI 工具的过度依赖，\n• 促进有意识的学习和反馈，\n• 在已验证技能、身份与 AI 支持之间建立透明的联系。",
                    layoutHeading: "原型卡片布局",
                    implHeading: "实现说明（原型）",
                    implText: "在完整部署中，可视卡片将显示在带有 NFC 核心的动态电子墨水屏上。NFC 芯片存储指向学习者已验证技能档案的 URL，SmarterYou 系统使用该链接来解锁相应的 AI 支持。",
                    nfcLabel: "NFC 编码（URI 记录 – 请使用此 URL 写入 NFC 卡）：",
                    footer: "SkillGPT 技能卡 – 探索以技能优先、负责任使用 AI 的 HCI 研究原型。"
                }
            },
            FR: {
                title: "Carte de Compétences",
                subtitle: "Débloque l'assistance IA",
                desktop: "Ordinateur",
                mobile: "Mobile",
                deskSteps: [
                    "Allez sur SkillGPT.ai et\nconnectez-vous",
                    "Dans « Connecter la carte de\ncompétences », choisissez :\n'QUEST_TR33_Was_BttR'",
                    "Vos compétences vérifiées\nseront synchronisées"
                ],
                mobSteps: [
                    "Ouvrez l'application SkillGPT",
                    "Approchez votre carte ou\nscannez le QR code",
                    "Les compétences seront\nsynchronisées et mises à jour"
                ],
                tagline: "L'IA n'est activée que pour les compétences que vous avez déjà prouvées — apprendre d'abord, automatiser ensuite.",
                others: "autres compétences",
                issued: "Délivré par",
                scan1: "Scannez ou approchez",
                scan2: "pour vous connecter à",
                scan3: "vos outils d'IA",
                ui: {
                    appTitle: "Générateur de Carte de Compétences",
                    languageLabel: "Langue",
                    firstNameLabel: "Prénom",
                    lastNameLabel: "Nom",
                    skillsLabel: "Compétences",
                    skillPlaceholder: "ex. Machine Learning",
                    addSkillButton: "Ajouter",
                    issuerLabel: "Logo de l'organisme émetteur (optionnel)",
                    generateButton: "Générer la carte",
                    rotateHint: "Faites glisser vers la gauche/droite pour faire tourner",
                    editButton: "Modifier",
                    printButton: "Imprimer le PDF",
                    firstNamePlaceholder: "Jean",
                    lastNamePlaceholder: "Dupont"
                },
                pdf: {
                    headerTitle: "Prototype de Carte de Compétences SkillGPT",
                    headerSubtitle: "Projet d'Interaction Homme–Machine (HCI) – Étude universitaire",
                    generatedForPrefix: "Carte prototype générée pour :",
                    intro: "Cette carte prototype fait partie d'un projet HCI qui explore comment réduire les usages négatifs de l'IA. Le système encourage les utilisateurs à développer d'abord de vraies compétences dans un domaine, puis à débloquer les outils d'IA pour automatiser les tâches dans ce domaine.",
                    rationale: "En liant l'accès à l'automatisation à une compétence démontrée, le projet vise à :\n• décourager la dépendance excessive aux outils d'IA génériques,\n• encourager un apprentissage réfléchi et le feedback,\n• créer un lien transparent entre compétences vérifiées, identité et assistance IA.",
                    layoutHeading: "Disposition de la carte prototype",
                    implHeading: "Notes de mise en œuvre (prototype)",
                    implText: "Dans un déploiement complet, la carte visuelle serait rendue sur un écran e-ink dynamique relié à un cœur NFC. La puce NFC stocke une URL vers le profil de compétences vérifiées de l'apprenant, que le système SkillGPT utilise pour débloquer l'assistance IA appropriée.",
                    nfcLabel: "Encodage NFC (enregistrement URI – programmez votre carte NFC avec cette URL) :",
                    footer: "Carte de Compétences SkillGPT – prototype de recherche HCI explorant un usage responsable de l'IA fondé sur les compétences."
                }
            },
            ES: {
                title: "Tarjeta de Habilidades",
                subtitle: "Desbloquea el soporte de IA",
                desktop: "Ordenador",
                mobile: "Móvil",
                deskSteps: [
                    "Ve a SkillGPT.ai e inicia sesión",
                    "En « Conectar Tarjeta de\nHabilidades », selecciona:\n'QUEST_TR33_Was_BttR'",
                    "Tus habilidades verificadas\nse sincronizarán"
                ],
                mobSteps: [
                    "Abre la aplicación SkillGPT",
                    "Toca tu tarjeta o escanea\nel código QR",
                    "Las habilidades se sincronizarán\ny se actualizarán"
                ],
                tagline: "La IA solo se desbloquea para las habilidades que ya has demostrado — primero aprender, después automatizar.",
                others: "otras habilidades",
                issued: "Emitido por",
                scan1: "Escanea o acerca",
                scan2: "para conectarte a",
                scan3: "tus herramientas de IA",
                ui: {
                    appTitle: "Generador de Tarjetas de Habilidades",
                    languageLabel: "Idioma",
                    firstNameLabel: "Nombre",
                    lastNameLabel: "Apellidos",
                    skillsLabel: "Habilidades",
                    skillPlaceholder: "p. ej. Machine Learning",
                    addSkillButton: "Añadir",
                    issuerLabel: "Logo de la entidad emisora (opcional)",
                    generateButton: "Generar tarjeta de habilidades",
                    rotateHint: "Arrastra hacia la izquierda/derecha para girar",
                    editButton: "Editar",
                    printButton: "Imprimir PDF",
                    firstNamePlaceholder: "Juan",
                    lastNamePlaceholder: "García"
                },
                pdf: {
                    headerTitle: "Prototipo de Tarjeta de Habilidades SkillGPT",
                    headerSubtitle: "Proyecto de Interacción Persona–Ordenador (HCI) – Estudio universitario",
                    generatedForPrefix: "Tarjeta prototipo generada para:",
                    intro: "Esta tarjeta prototipo forma parte de un proyecto de HCI que explora cómo reducir los patrones negativos de uso de la IA. El sistema anima a las personas a desarrollar primero habilidades reales en un dominio y solo después desbloquear herramientas de IA para automatizar tareas en ese ámbito.",
                    rationale: "Al vincular el acceso a la automatización con la competencia demostrada, el proyecto pretende:\n• desincentivar la dependencia excesiva de herramientas de IA genéricas,\n• promover un aprendizaje deliberado y el feedback, y\n• crear un vínculo transparente entre habilidades verificadas, identidad y asistencia de IA.",
                    layoutHeading: "Diseño de la tarjeta prototipo",
                    implHeading: "Notas de implementación (prototipo)",
                    implText: "En un despliegue completo, la tarjeta visual se renderizaría en una pantalla de tinta electrónica dinámica conectada a un núcleo NFC. El chip NFC almacena una URL que apunta al perfil de habilidades verificadas de la persona, que el sistema SkillGPT utiliza para desbloquear la asistencia de IA adecuada.",
                    nfcLabel: "Codificación NFC (registro URI – programa tu tarjeta NFC con esta URL):",
                    footer: "Tarjeta de Habilidades SkillGPT – prototipo de investigación HCI que explora un uso responsable de la IA basado en las habilidades."
                }
            },
            DE: {
                title: "Fähigkeitenkarte",
                subtitle: "Schaltet KI-Unterstützung frei",
                desktop: "Desktop",
                mobile: "Mobil",
                deskSteps: [
                    "Gehe auf SkillGPT.ai und\nmelde dich an",
                    "Wähle unter „Skill Card\nverbinden“:\n'QUEST_TR33_Was_BttR'",
                    "Deine verifizierten Fähigkeiten\nwerden synchronisiert"
                ],
                mobSteps: [
                    "Öffne die SkillGPT-App",
                    "Halte deine Karte an das Gerät\noder scanne den QR-Code",
                    "Fähigkeiten werden\nsynchronisiert und aktualisiert"
                ],
                tagline: "KI wird nur für Fähigkeiten freigeschaltet, die du bereits nachgewiesen hast – zuerst lernen, dann automatisieren.",
                others: "weitere Fähigkeiten",
                issued: "Ausgestellt von",
                scan1: "Scannen oder halten",
                scan2: "um eine Verbindung zu",
                scan3: "deinen KI-Tools herzustellen",
                ui: {
                    appTitle: "Fähigkeitenkarten-Generator",
                    languageLabel: "Sprache",
                    firstNameLabel: "Vorname",
                    lastNameLabel: "Nachname",
                    skillsLabel: "Fähigkeiten",
                    skillPlaceholder: "z. B. Machine Learning",
                    addSkillButton: "Hinzufügen",
                    issuerLabel: "Logo der ausstellenden Organisation (optional)",
                    generateButton: "Fähigkeitenkarte erzeugen",
                    rotateHint: "Zum Drehen nach links/rechts ziehen",
                    editButton: "Bearbeiten",
                    printButton: "PDF drucken",
                    firstNamePlaceholder: "Max",
                    lastNamePlaceholder: "Muster"
                },
                pdf: {
                    headerTitle: "SkillGPT Fähigkeitenkarten-Prototyp",
                    headerSubtitle: "Human–Computer Interaction (HCI) Projekt – Universitätsstudie",
                    generatedForPrefix: "Prototyp-Karte erzeugt für:",
                    intro: "Diese prototypische Karte ist Teil eines HCI-Projekts, das untersucht, wie negative Muster der KI-Nutzung verringert werden können. Das System ermutigt Menschen, zunächst reale Fähigkeiten in einem Bereich aufzubauen und erst danach KI-Werkzeuge freizuschalten, um Aufgaben in diesem Bereich zu automatisieren.",
                    rationale: "Indem der Zugang zur Automatisierung an nachgewiesene Kompetenz geknüpft wird, hat das Projekt zum Ziel:\n• eine übermäßige Abhängigkeit von generischen KI-Tools zu vermeiden,\n• bewusstes Lernen und Feedback zu fördern und\n• eine transparente Verbindung zwischen verifizierten Fähigkeiten, Identität und KI-Unterstützung zu schaffen.",
                    layoutHeading: "Layout der Prototyp-Karte",
                    implHeading: "Hinweise zur Implementierung (Prototyp)",
                    implText: "In einem vollständigen Einsatz würde die visuelle Karte auf einem dynamischen E-Ink-Display mit NFC-Kern dargestellt. Der NFC-Chip speichert eine URL, die auf das verifizierte Fähigkeitsprofil der lernenden Person zeigt, das das SkillGPT-System nutzt, um passende KI-Unterstützung freizuschalten.",
                    nfcLabel: "NFC-Codierung (URI-Eintrag – programmieren Sie Ihre NFC-Karte mit dieser URL):",
                    footer: "SkillGPT Fähigkeitenkarte – HCI-Forschungsprototyp für kompetenzorientierte, verantwortungsvolle KI-Nutzung."
                }
            }
        };
        function applyLanguage(lang) {
            const config = dictionary[lang] || dictionary.EN;
            const ui = config.ui || dictionary.EN.ui;

            const titleEl = document.getElementById('app-title');
            if (titleEl) titleEl.textContent = ui.appTitle;

            const lblLang = document.getElementById('label-language');
            if (lblLang) lblLang.textContent = ui.languageLabel;

            const lblFname = document.getElementById('label-fname');
            if (lblFname) lblFname.textContent = ui.firstNameLabel;

            const lblLname = document.getElementById('label-lname');
            if (lblLname) lblLname.textContent = ui.lastNameLabel;

            const lblSkills = document.getElementById('label-skills');
            if (lblSkills) lblSkills.textContent = ui.skillsLabel;

            const lblIssuer = document.getElementById('label-issuer');
            if (lblIssuer) lblIssuer.textContent = ui.issuerLabel;

            const skillInput = document.getElementById('skill-input');
            if (skillInput) skillInput.placeholder = ui.skillPlaceholder;

            const fnameInput = document.getElementById('fname');
            if (fnameInput && ui.firstNamePlaceholder) fnameInput.placeholder = ui.firstNamePlaceholder;

            const lnameInput = document.getElementById('lname');
            if (lnameInput && ui.lastNamePlaceholder) lnameInput.placeholder = ui.lastNamePlaceholder;

            const btnAdd = document.getElementById('btn-add-skill');
            if (btnAdd) btnAdd.textContent = ui.addSkillButton;

            const btnGenerate = document.getElementById('btn-generate');
            if (btnGenerate) btnGenerate.textContent = ui.generateButton;

            const rotateHint = document.getElementById('rotate-hint');
            if (rotateHint) rotateHint.textContent = ui.rotateHint;

            const btnEdit = document.getElementById('btn-edit');
            if (btnEdit) btnEdit.textContent = ui.editButton;

            const btnPrint = document.getElementById('btn-print');
            if (btnPrint) btnPrint.textContent = ui.printButton;
        }

        const langSelect = document.getElementById('language');
        if (langSelect) {
            applyLanguage(langSelect.value);
            langSelect.addEventListener('change', function() {
                applyLanguage(this.value);
            });
        }

        const baseUrlMap = {
            EN: "https://www.smartYou.ai/en",
            VI: "https://www.smartYou.ai/vi",
            ZH: "https://www.smartYou.ai/zh",
            FR: "https://www.smartYou.ai/fr",
            ES: "https://www.smartYou.ai/es",
            DE: "https://www.smartYou.ai/de"
        };

        // --- Form Logic ---
        
        function addSkill() {
            const input = document.getElementById('skill-input');
            const val = input.value.trim();
            if (val) {
                skills.push(val);
                renderSkills();
                input.value = '';
            }
        }

        function removeSkill(index) {
            skills.splice(index, 1);
            renderSkills();
        }

        function renderSkills() {
            const container = document.getElementById('skills-display');
            container.innerHTML = '';
            skills.forEach((s, i) => {
                const tag = document.createElement('div');
                tag.className = 'skill-tag';
                tag.innerHTML = `${s} <span class="remove-skill" onclick="removeSkill(${i})">&times;</span>`;
                container.appendChild(tag);
            });
        }

        // Handle Image Upload
        document.getElementById('logo-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    logoDataUrl = evt.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Generation Logic ---

        async function generateCard() {
            const fname = document.getElementById('fname').value || "John";
            const lname = document.getElementById('lname').value || "Doe";
            const lang = document.getElementById('language').value;

            if (skills.length === 0) {
                alert("Please add at least one skill.");
                return;
            }

            // Show UI
            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('output-section').classList.remove('hidden');
            document.getElementById('main-container').classList.add('wide');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('viewport').style.display = 'block';

            // Generate UUID for card
            const cardUID = generateUUID();

            cardData = {
                cardUID: cardUID,
                name: `${fname} ${lname}`,
                skills: skills,
                language: lang,
                issuer: logoDataUrl
            };

            // Upload to Firebase
            await uploadToFirebase(cardUID);

            // Wait a moment for UI transition
            setTimeout(async () => {
                await drawCanvases();
                initThreeJS();
                document.getElementById('loader').classList.add('hidden');
            }, 500);
        }

        // --- Canvas Drawing (Texture Generation) ---

        function drawCanvases() {
            return new Promise((resolve) => {
                const t = dictionary[cardData.language];
                const ctxFront = document.getElementById('canvas-front').getContext('2d');
                const ctxBack = document.getElementById('canvas-back').getContext('2d');
                const w = 2048;
                const h = 1296;

                const radius = 80;
                function drawRoundedRect(ctx, x, y, width, height, r) {
                    ctx.beginPath();
                    ctx.moveTo(x + r, y);
                    ctx.lineTo(x + width - r, y);
                    ctx.quadraticCurveTo(x + width, y, x + width, y + r);
                    ctx.lineTo(x + width, y + height - r);
                    ctx.quadraticCurveTo(x + width, y + height, x + width - r, y + height);
                    ctx.lineTo(x + r, y + height);
                    ctx.quadraticCurveTo(x, y + height, x, y + height - r);
                    ctx.lineTo(x, y + r);
                    ctx.quadraticCurveTo(x, y, x + r, y);
                    ctx.closePath();
                }

                // --- Draw Front ---
                // Background with rounded card border
                ctxFront.clearRect(0, 0, w, h);
                ctxFront.fillStyle = "#ffffff";
                // Fill the whole canvas so the corners are white in JPEG/PDF exports
                ctxFront.fillRect(0, 0, w, h);
                ctxFront.strokeStyle = "#cccccc"; // light grey border
                ctxFront.lineWidth = 12;
                drawRoundedRect(ctxFront, 10, 10, w - 20, h - 20, radius);
                ctxFront.fill();
                ctxFront.stroke();

                // Header
                ctxFront.fillStyle = "#000000";
                const maxFrontTextWidth = w - 860; // leave room for QR + margins on the right
                // Title – shrink if it would overlap the QR area
                setFittedFont(ctxFront, 120, 56, "bold", "Helvetica", t.title, maxFrontTextWidth);
                ctxFront.fillText(t.title, 100, 180);

                // Subtitle – also constrained by the same width
                setFittedFont(ctxFront, 80, 40, "bold", "Helvetica", t.subtitle, maxFrontTextWidth);
                ctxFront.fillText(t.subtitle, 100, 280);

                // Scan / NFC text top-right
                const qrLeftX = w - 720;   // same left edge as QR
                let scanY = 140;           // position above QR
                ctxFront.textAlign = "left";
                const maxScanWidth = 640; // width from qrLeftX to the card edge
                const longestScan = [t.scan1, t.scan2, t.scan3].reduce((a, b) => (a.length > b.length ? a : b), "");
                setFittedFont(ctxFront, 48, 28, "", "Helvetica", longestScan, maxScanWidth);
                ctxFront.fillText(t.scan1, qrLeftX, scanY);
                scanY += 56;
                ctxFront.fillText(t.scan2, qrLeftX, scanY);
                scanY += 56;
                ctxFront.fillText(t.scan3, qrLeftX, scanY);

                // NFC / wireless icon using SVG drawn to canvas (e-ink friendly, black only)
                const contactlessSVG = `
                    <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="512" height="512">
                    <path d="M0 0 C0.93328125 -0.03738281 1.8665625 -0.07476563 2.828125 -0.11328125 C9.06257084 0.7952142 13.30671771 5.53897305 17.5625 9.875 C18.08312012 10.4009375 18.60374023 10.926875 19.14013672 11.46875 C23.2041817 15.63137022 26.93706838 20.00091231 30.5546875 24.55859375 C32.80924513 27.38681996 35.14876109 30.12684777 37.5 32.875 C82.3357265 86.7887484 108.58506253 155.75117561 114.75 225.3125 C114.91822266 227.10107422 114.91822266 227.10107422 115.08984375 228.92578125 C121.77108565 314.13449641 96.81038812 402.36077598 44.75 470.3125 C44.28706543 470.91964844 43.82413086 471.52679688 43.34716797 472.15234375 C38.0816236 479.03483767 32.67161596 485.69632954 26.80078125 492.078125 C24.88614309 494.16416886 23.03177042 496.28932046 21.1875 498.4375 C9.485048 511.82728228 9.485048 511.82728228 3.1640625 512.6484375 C-2.83584459 512.73246981 -6.58907492 512.50733258 -11.25 508.3125 C-14.79615362 504.27722174 -15.57069284 500.73419726 -15.453125 495.35546875 C-14.8310265 489.09859343 -10.62715062 485.48744007 -6.34765625 481.36328125 C-3.10217603 478.19032573 -0.19410875 474.76299545 2.75 471.3125 C3.93335938 469.96285156 3.93335938 469.96285156 5.140625 468.5859375 C61.16189505 404.23421145 88.5212066 318.63778757 83 233.8125 C79.87725947 191.18192543 68.91576469 149.55209029 49.75 111.3125 C49.33395508 110.47090332 48.91791016 109.62930664 48.48925781 108.76220703 C35.70779176 83.05230326 19.18481031 59.87890297 -0.1171875 38.66015625 C-3.21162921 35.25400338 -6.24046629 31.79367705 -9.25 28.3125 C-9.74757813 27.74402344 -10.24515625 27.17554687 -10.7578125 26.58984375 C-14.52197895 22.21265591 -15.56104893 19.19685162 -15.46484375 13.37109375 C-14.98807026 8.80273683 -13.02437114 6.01132274 -9.6875 3 C-6.19236964 0.58029437 -4.22980736 0.10979008 0 0 Z " fill="#000000" transform="translate(302.25,-0.3125)"/>
                    <path d="M0 0 C11.87480745 6.43218737 21.03842111 20.70483482 29 31.328125 C29.43054688 31.90175781 29.86109375 32.47539063 30.3046875 33.06640625 C36.81165509 41.80151729 42.66114343 50.83513987 48 60.328125 C48.4345752 61.1001123 48.86915039 61.87209961 49.31689453 62.66748047 C76.97125511 112.34709022 87.8247368 170.96203615 80 227.328125 C79.87641113 228.2248291 79.75282227 229.1215332 79.62548828 230.04541016 C72.08419174 282.50541118 48.85321772 330.95158895 13.12890625 369.96875 C11.1265173 372.18791133 9.22154093 374.46638449 7.3125 376.765625 C3.85714262 380.67065217 0.93906791 382.94811458 -4.38671875 383.63671875 C-10.09565941 383.91832569 -13.61893849 383.29194256 -18 379.328125 C-21.20299222 375.78797571 -22.28693393 373.07097624 -22.5 368.390625 C-22.04473632 359.4058624 -16.90325362 355.12959438 -10.77734375 349.18359375 C-5.69344371 343.95668667 -1.37245614 338.15115901 3 332.328125 C3.62624268 331.50900635 3.62624268 331.50900635 4.26513672 330.67333984 C41.37068241 281.99898856 55.75443974 219.15314324 47.96875 158.9296875 C41.16428505 110.63766869 19.82060384 66.74961102 -13.38671875 31.1875 C-19.21057928 24.81520417 -22.39390173 20.72929065 -22.27734375 11.83203125 C-21.72087408 6.80812898 -18.97908624 4.21396493 -15.375 0.953125 C-10.24332999 -1.51767908 -5.44514765 -1.82922929 0 0 Z " fill="#000000" transform="translate(245,64.671875)"/>
                    <path d="M0 0 C28.54034921 19.22105151 45.39310241 60.39940915 52.0625 92.796875 C60.56245198 136.52440575 52.70816582 184.12127437 28.13671875 221.65625 C7.82520246 251.47493251 7.82520246 251.47493251 -2.9375 255.0625 C-8.55625724 255.4309431 -12.09461379 255.25440228 -16.9375 252.0625 C-20.78461726 248.32224711 -22.57204426 244.37122543 -22.9375 239.0625 C-22.38767708 232.04571227 -18.05998075 227.6864907 -13.40600586 222.84765625 C12.30809335 195.98781702 24.00540154 158.31936202 23.30859375 121.68359375 C22.12576432 87.40507924 8.41184234 54.16831707 -15.3125 29.375 C-19.3763759 24.96930276 -22.35500414 21.15630285 -22.9375 15.0625 C-22.6290475 9.06970853 -20.1546475 5.1815743 -15.9375 1.0625 C-10.9592876 -1.89751818 -5.37076228 -1.71407307 0 0 Z " fill="#000000" transform="translate(180.9375,128.9375)"/>
                    <path d="M0 0 C0.72960937 0.05542969 1.45921875 0.11085937 2.2109375 0.16796875 C11.36963236 2.61325136 17.17805285 12.03108195 21.79296875 19.77148438 C33.07731456 39.98432135 36.99009904 62.43859804 31.73046875 85.15625 C27.20405539 100.12700232 19.55608368 115.71082647 7.25 125.75 C1.94696043 127.8964684 -2.60838968 128.31303959 -8.125 126.75 C-12.73195296 124.00354727 -15.63977648 121.01817055 -17.375 115.8125 C-17.9689523 109.75418653 -16.66033693 105.78386027 -13.375 100.8125 C-12.27246746 99.56314109 -11.14604288 98.33457076 -10 97.125 C-0.66732208 86.92930025 2.11571768 73.74955522 1.87109375 60.3671875 C0.93020815 46.77661775 -4.86484871 36.2719389 -13.640625 26.1015625 C-17.11917362 21.51050508 -17.87587904 17.52252102 -17.375 11.8125 C-15.48241259 6.55531274 -12.81296456 3.98247468 -8.375 0.8125 C-5.47139067 -0.16916833 -3.0407263 -0.2827342 0 0 Z " fill="#000000" transform="translate(111.375,192.1875)"/>
                    </svg>
                `;
                const contactlessImg = new Image();
                contactlessImg.onload = () => {
                    const iconSize = 128;
                    // position the icon near the scan text, above the QR code
                    const iconX = qrLeftX + 480;
                    const iconY = 120;
                    ctxFront.drawImage(contactlessImg, iconX, iconY, iconSize, iconSize);
                };
                contactlessImg.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(contactlessSVG);

                ctxFront.textAlign = "left";

                // Horizontal Line
                ctxFront.beginPath();
                ctxFront.moveTo(80, 340);
                ctxFront.lineTo(w - 80, 340);
                ctxFront.lineWidth = 8;
                ctxFront.stroke();

                // Name – constrained so it does not overlap the QR code
                const maxNameWidth = w - 860; // same idea as title/subtitle
                setFittedFont(ctxFront, 110, 56, "bold", "Helvetica", cardData.name, maxNameWidth);
                ctxFront.fillText(cardData.name, 100, 500);

                // Skills – all share a fitted font so they stay within the card area
                const skillTexts = [];
                if (cardData.skills[0]) skillTexts.push(cardData.skills[0]);
                if (cardData.skills[1]) skillTexts.push(cardData.skills[1]);
                let remaining = 0;
                if (cardData.skills.length > 2) {
                    remaining = cardData.skills.length - 2;
                    skillTexts.push(`+${remaining} ${t.others}`);
                }

                const longestSkillText = skillTexts.reduce((a, b) => (a.length > b.length ? a : b), "");
                const maxSkillWidth = w - 860;
                // Base 80px, but shrink as needed (down to 40px)
                setFittedFont(ctxFront, 80, 40, "", "Helvetica", longestSkillText, maxSkillWidth);

                let currentY = 640;

                // Skill 1
                if (cardData.skills[0]) {
                    ctxFront.fillStyle = "#000";
                    ctxFront.fillText(cardData.skills[0], 100, currentY);
                    currentY += 100;
                }
                // Skill 2
                if (cardData.skills[1]) {
                    ctxFront.fillStyle = "#000";
                    ctxFront.fillText(cardData.skills[1], 100, currentY);
                    currentY += 100;
                }
                // Others (rendered in a slightly softer colour)
                if (cardData.skills.length > 2) {
                    ctxFront.fillStyle = "#555";
                    ctxFront.fillText(`+${remaining} ${t.others}`, 100, currentY);
                    ctxFront.fillStyle = "#000";
                }

                // Issuer text and logo (black & white for e-ink)
                if (cardData.issuer) {
                    ctxFront.font = "60px Helvetica";
                    ctxFront.fillStyle = "#000000";
                    ctxFront.fillText(t.issued, 100, h - 320);

                    const img = new Image();
                    img.onload = () => {
                        // Draw to an offscreen canvas to convert to grayscale
                        const offCanvas = document.createElement('canvas');
                        offCanvas.width = img.width;
                        offCanvas.height = img.height;
                        const offCtx = offCanvas.getContext('2d');
                        offCtx.drawImage(img, 0, 0);
                        const imageData = offCtx.getImageData(0, 0, offCanvas.width, offCanvas.height);
                        const data = imageData.data;
                        for (let i = 0; i < data.length; i += 4) {
                            const r = data[i];
                            const g = data[i + 1];
                            const b = data[i + 2];
                            const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                            data[i] = data[i + 1] = data[i + 2] = gray;
                        }
                        offCtx.putImageData(imageData, 0, 0);

                        // Constrain logo size and draw grayscale version while preserving aspect ratio
                        const maxLogoW = 440;
                        const maxLogoH = 140;
                        let drawW = offCanvas.width;
                        let drawH = offCanvas.height;
                        const scale = Math.min(maxLogoW / drawW, maxLogoH / drawH);
                        drawW *= scale;
                        drawH *= scale;

                        ctxFront.drawImage(
                            offCanvas,
                            0,
                            0,
                            offCanvas.width,
                            offCanvas.height,
                            100,
                            h - 280,
                            drawW,
                            drawH
                        );
                        finishFront();
                    };
                    img.src = cardData.issuer;
                } else {
                    // Fallback text and placeholder issuer
                    ctxFront.font = "60px Helvetica";
                    ctxFront.fillStyle = "#000000";
                    ctxFront.fillText(t.issued, 100, h - 320);
                    ctxFront.font = "bold 60px Helvetica";
                    ctxFront.fillText("SmartYou University", 100, h - 240);
                    finishFront();
                }

                function finishFront() {
                    // QR Code
                    const qrDiv = document.getElementById('qr-target');
                    qrDiv.innerHTML = '';

                    // Build URL with cardUID for QR + NFC
                    const qrUrl = `https://jwu56.github.io/react-skilltree?cardId=${cardData.cardUID}`;

                    // Store URL so we can also render it into the PDF / NFC instructions
                    cardData.qrUrl = qrUrl;

                    try {
                        new QRCode(qrDiv, {
                            text: qrUrl,
                            width: 512,
                            height: 512
                        });
                    } catch (e) {
                        console.error('QR generation failed', e);
                        qrDiv.innerHTML = '<p>QR code error</p>';
                    }

                    // QR Code is generated async inside div as an img tag
                    // We need to wait for the img src to populate
                    const checkQR = setInterval(() => {
                        const qrImg = qrDiv.querySelector('img');
                        if (qrImg && qrImg.src) {
                            clearInterval(checkQR);
                            const i = new Image();
                            i.onload = () => {
                                ctxFront.drawImage(i, w - 720, 420, 640, 640);
                                drawBack(); // Proceed to back
                            };
                            i.src = qrImg.src;
                        }
                    }, 50);
                }


                // --- Draw Back ---
                function drawBack() {
                    ctxBack.clearRect(0, 0, w, h);
                    ctxBack.fillStyle = "#ffffff";
                    // Fill the whole canvas so the corners are white in JPEG/PDF exports
                    ctxBack.fillRect(0, 0, w, h);
                    ctxBack.strokeStyle = "#cccccc"; // light grey border
                    ctxBack.lineWidth = 12;
                    drawRoundedRect(ctxBack, 10, 10, w - 20, h - 20, radius);
                    ctxBack.fill();
                    ctxBack.stroke();

                    // Black strip header (simulating the NFC/Tech strip), inset to respect rounded corners
                    ctxBack.fillStyle = "#000000";
                    ctxBack.fillRect(40, 80, w - 80, 300);

                    // Instructions title
                    ctxBack.fillStyle = "#000000";
                    ctxBack.font = "bold 80px Helvetica";
                    ctxBack.fillText("Instructions", 80, 520);

                    // Column positions
                    const col1X = 80;          // Desktop column
                    const col2X = w / 2 + 40;  // Mobile column
                    const startY = 620;

                    const deskSteps = t.deskSteps;
                    const mobSteps = t.mobSteps;

                    // Helper: draw one numbered step block in a column, supporting '\n' line breaks
                    function drawStepColumn(steps, x, startYLocal) {
                        let yLocal = startYLocal;
                        steps.forEach((stepText, index) => {
                            const lines = stepText.split('\n');
                            ctxBack.font = "52px Helvetica";
                            lines.forEach((line, lineIdx) => {
                                const prefix = (lineIdx === 0) ? `${index + 1}. ` : "    ";
                                ctxBack.fillText(prefix + line, x, yLocal);
                                yLocal += 60;
                            });
                            yLocal += 12; // extra spacing after each step
                        });
                        return yLocal;
                    }

                    // Desktop section (left column)
                    ctxBack.font = "bold 64px Helvetica";
                    ctxBack.fillText(t.desktop, col1X, startY);
                    const desktopBottomY = drawStepColumn(deskSteps, col1X, startY + 60);

                    // Mobile section (right column)
                    ctxBack.font = "bold 64px Helvetica";
                    ctxBack.fillText(t.mobile, col2X, startY);
                    const mobileBottomY = drawStepColumn(mobSteps, col2X, startY + 60);

                    // Tagline underneath both columns
                    ctxBack.font = "italic 52px Helvetica";
                    ctxBack.fillStyle = "#444";

                    const taglineTop = Math.max(desktopBottomY, mobileBottomY) + 40;

                    // Simple word wrap for tagline
                    const words = t.tagline.split(' ');
                    let line = '';
                    let tagY = taglineTop;

                    for (let n = 0; n < words.length; n++) {
                        const testLine = line + words[n] + ' ';
                        const metrics = ctxBack.measureText(testLine);
                        if (metrics.width > w - 160 && n > 0) {
                            ctxBack.fillText(line, 80, tagY);
                            line = words[n] + ' ';
                            tagY += 70;
                        } else {
                            line = testLine;
                        }
                    }
                    ctxBack.fillText(line, 80, tagY);

                    // Language code in header (lower and slightly to the right)
                    ctxBack.fillStyle = "#ffffff";
                    ctxBack.font = "bold 64px Helvetica";
                    ctxBack.fillText(cardData.language, 80, 240);

                    // NFC / wireless icon on back using a high-contrast white-stroke icon
                    const contactlessBackSVG = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
                          <g fill="none" stroke="white" stroke-width="3" stroke-linecap="round">
                            <path d="M20 16c8 4 12 12 12 16s-4 12-12 16"/>
                            <path d="M28 12c8 6 12 14 12 20s-4 14-12 20"/>
                            <path d="M36 8c8 8 12 16 12 24s-4 16-12 24"/>
                          </g>
                        </svg>
                    `;
                    const contactlessBackImg = new Image();
                    contactlessBackImg.onload = () => {
                        const iconSize = 96;
                        const iconX = w - 180;   // slightly further right
                        const iconY = 240;      // lower in the strip
                        ctxBack.drawImage(contactlessBackImg, iconX, iconY, iconSize, iconSize);
                        resolve();
                    };
                    contactlessBackImg.onerror = () => {
                        // Fallback: still resolve even if icon fails to load
                        resolve();
                    };
                    contactlessBackImg.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(contactlessBackSVG);
                }
            });
        }

        // --- Three.js Logic ---
        
        let scene, camera, renderer, cardMesh;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };

        function onWindowResize() {
            const viewport = document.getElementById('viewport');
            if (!viewport || !renderer || !camera) return;

            const width = viewport.clientWidth;
            const height = viewport.clientHeight || 300;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();

            renderer.setSize(width, height);
        }

        function initThreeJS() {
            const viewport = document.getElementById('viewport');
            const loaderEl = document.getElementById('loader');
            viewport.innerHTML = ''; // Clear previous if any
            if (loaderEl) {
                viewport.appendChild(loaderEl); // Re-attach loader overlay
            }

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xeeeeee);

            // Camera
            camera = new THREE.PerspectiveCamera(45, viewport.clientWidth / viewport.clientHeight, 0.1, 1000);
            camera.position.z = 5;

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(viewport.clientWidth, viewport.clientHeight);
            viewport.appendChild(renderer.domElement);

            // Make renderer responsive to window size
            onWindowResize();

            // Textures
            const texFront = new THREE.CanvasTexture(document.getElementById('canvas-front'));
            const texBack = new THREE.CanvasTexture(document.getElementById('canvas-back'));
            
            // Improve texture quality
            texFront.encoding = THREE.sRGBEncoding;
            texFront.anisotropy = renderer.capabilities.getMaxAnisotropy();
            texFront.minFilter = THREE.LinearFilter;
            texFront.magFilter = THREE.LinearFilter;
            
            texBack.encoding = THREE.sRGBEncoding;
            texBack.anisotropy = renderer.capabilities.getMaxAnisotropy();
            texBack.minFilter = THREE.LinearFilter;
            texBack.magFilter = THREE.LinearFilter;

            // Geometry (Card shape: Width 1.58, Height 1, Depth 0.02)
            const geometry = new THREE.BoxGeometry(2.8, 1.76, 0.02); // Scaled up slightly for view

            // Materials (6 sides: Right, Left, Top, Bottom, Front, Back)
            const materialSide = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const materialFront = new THREE.MeshBasicMaterial({ map: texFront });
            const materialBack = new THREE.MeshBasicMaterial({ map: texBack });

            const materials = [
                materialSide, // Right
                materialSide, // Left
                materialSide, // Top
                materialSide, // Bottom
                materialFront, // Front
                materialBack   // Back
            ];

            cardMesh = new THREE.Mesh(geometry, materials);
            scene.add(cardMesh);

            // Interaction Handlers
            renderer.domElement.addEventListener('mousedown', onMouseDown);
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.domElement.addEventListener('mouseup', onMouseUp);
            renderer.domElement.addEventListener('mouseleave', onMouseUp);
            
            // Touch support
            renderer.domElement.addEventListener('touchstart', onTouchStart, {passive: false});
            renderer.domElement.addEventListener('touchmove', onTouchMove, {passive: false});
            renderer.domElement.addEventListener('touchend', onMouseUp);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // --- Interaction Logic ---

        function onMouseDown(e) {
            isDragging = true;
            previousMousePosition = { x: e.offsetX, y: e.offsetY };
        }

        function onMouseMove(e) {
            if (!isDragging) return;
            const deltaMove = { x: e.offsetX - previousMousePosition.x };
            
            // Rotate card on Y axis
            cardMesh.rotation.y += deltaMove.x * 0.01;
            
            previousMousePosition = { x: e.offsetX, y: e.offsetY };
        }

        function onMouseUp() {
            isDragging = false;
        }

        // Touch handlers maps to mouse logic
        function onTouchStart(e) {
            e.preventDefault();
            isDragging = true;
            const touch = e.touches[0];
            const rect = e.target.getBoundingClientRect();
            previousMousePosition = { x: touch.clientX - rect.left, y: 0 };
        }

        function onTouchMove(e) {
            e.preventDefault();
            if (!isDragging) return;
            const touch = e.touches[0];
            const rect = e.target.getBoundingClientRect();
            const currentX = touch.clientX - rect.left;
            
            const deltaX = currentX - previousMousePosition.x;
            cardMesh.rotation.y += deltaX * 0.01;
            previousMousePosition = { x: currentX, y: 0 };
        }

        // Make Three.js viewport responsive
        window.addEventListener('resize', onWindowResize);


        // --- PDF Generation ---

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const langConfig = dictionary[cardData.language] || dictionary.EN;
            const tPdf = langConfig.pdf || dictionary.EN.pdf;

            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const frontData = document.getElementById('canvas-front').toDataURL('image/jpeg', 1.0);
            const backData = document.getElementById('canvas-back').toDataURL('image/jpeg', 1.0);

            const cardW = 85;
            const cardH = 53;
            const margin = 15;

            const pageWidth = doc.internal.pageSize.getWidth();
            const centerX = pageWidth / 2;

            // --- Official-looking header ---
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.text(tPdf.headerTitle, centerX, 18, { align: 'center' });

            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(tPdf.headerSubtitle, centerX, 25, { align: 'center' });

            // Optional card-holder line if we have a name
            if (cardData && cardData.name) {
                doc.setFontSize(11);
                doc.text(`${tPdf.generatedForPrefix} ${cardData.name}`, centerX, 32, { align: 'center' });
            }

            // --- Project overview + rationale ---
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            let cursorY = 40;

            const introLines = doc.splitTextToSize(tPdf.intro, pageWidth - 2 * margin);
            doc.text(introLines, margin, cursorY);
            cursorY += introLines.length * 5.5 + 4;

            const rationaleLines = doc.splitTextToSize(tPdf.rationale, pageWidth - 2 * margin);
            doc.text(rationaleLines, margin, cursorY);
            cursorY += rationaleLines.length * 5.5 + 6;

            // --- Prototype card layout section ---
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text(tPdf.layoutHeading, margin, cursorY);
            cursorY += 4;

            // Labels above images
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            const startY = cursorY + 2;

            doc.text(`${langConfig.title} – Front`, margin, startY - 3);
            doc.addImage(frontData, 'JPEG', margin, startY, cardW, cardH);

            doc.text('Back', margin + cardW + 10, startY - 3);
            doc.addImage(backData, 'JPEG', margin + cardW + 10, startY, cardW, cardH);

            // --- Implementation / NFC notes ---
            const nfcY = startY + cardH + 15;
            const qrUrl = cardData.qrUrl || 'https://www.SkillGPT.ai/';

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text(tPdf.implHeading, margin, nfcY);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            const implLines = doc.splitTextToSize(tPdf.implText, pageWidth - 2 * margin);
            doc.text(implLines, margin, nfcY + 5);

            const urlLabelY = nfcY + 5 + implLines.length * 5.5 + 4;
            doc.setFont('helvetica', 'bold');
            doc.text(tPdf.nfcLabel, margin, urlLabelY);

            const urlLines = doc.splitTextToSize(qrUrl, pageWidth - 2 * margin);
            doc.setFont('helvetica', 'normal');
            doc.text(urlLines, margin, urlLabelY + 5.5);

            // --- Footer ---
            const footerY = 290;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'italic');
            doc.text(tPdf.footer, centerX, footerY, { align: 'center' });

            doc.save('my-skill-card.pdf');
        }

        // --- Reset ---

        function resetApp() {
            // Just return the user to the form without clearing their data
            document.getElementById('input-section').classList.remove('hidden');
            document.getElementById('output-section').classList.add('hidden');
            document.getElementById('main-container').classList.remove('wide');
            // Re-render skills so the tags stay visible in the form
            renderSkills();
        }
    </script>
</body>
</html>
